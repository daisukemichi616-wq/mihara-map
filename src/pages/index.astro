---
import Layout from '../layouts/Layout.astro';
import { fetchSpots } from '../utils/google-sheets';
const spots = await fetchSpots();
const reversedSpots = [...spots].reverse();
---
<Layout>
    <nav class="fixed top-0 w-full bg-white/90 backdrop-blur z-50 border-b p-4 flex justify-between items-center h-[60px]">
        <div class="font-bold text-blue-900 tracking-widest text-sm">MIHARA REDISCOVER</div>
        <button id="rpg-btn" class="text-[10px] bg-blue-900 text-white px-3 py-1 rounded-full font-bold shadow"><i class="fa-solid fa-dungeon"></i> 冒険の扉</button>
    </nav>
    <div class="pt-[60px]">
        <div class="h-[40vh] bg-gray-200 flex items-center justify-center relative overflow-hidden">
             <img src="https://i.postimg.cc/Dy2sThhC/IMG-9586.jpg" class="absolute inset-0 w-full h-full object-cover opacity-80" />
             <div class="relative z-10 text-center text-white drop-shadow-lg">
                <h1 class="serif text-3xl font-bold mb-2">まだ知らない三原の景色を</h1>
                <p class="text-[10px] font-bold tracking-[0.3em]">PHOTO MAP PROJECT</p>
             </div>
        </div>
        <div class="max-w-7xl mx-auto px-4 py-10">
            <h2 class="text-center serif text-2xl font-bold text-blue-900 mb-6">PHOTO MAP</h2>
            <div id="map" class="w-full h-[400px] rounded-lg border z-0 mb-10 shadow-sm"></div>
            <div class="grid grid-cols-3 md:grid-cols-4 gap-1">
                {reversedSpots.map((spot) => (
                    <a href={`/spots/${spot.slug}`} class="block relative aspect-square group overflow-hidden bg-gray-100">
                        <img src={spot.imageUrl} class="w-full h-full object-cover transition duration-500 group-hover:scale-110" loading="lazy" />
                        <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition flex items-center justify-center p-2"><span class="text-white text-[10px] md:text-xs font-bold text-center">{spot.title}</span></div>
                    </a>
                ))}
            </div>
        </div>
    </div>
    <script id="spots-data" type="application/json">{JSON.stringify(reversedSpots)}</script>
    <script>
        import L from 'leaflet';
        import 'leaflet.markercluster';
        const spots = JSON.parse(document.getElementById('spots-data').textContent);
        const map = L.map('map').setView([34.4000, 133.0800], 12);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: 'OSM' }).addTo(map);
        const markers = L.markerClusterGroup();
        spots.forEach(s => {
            if(s.lat && s.lng) {
                const html = `<div style="width:200px"><img src="${s.imageUrl}" style="width:100%;height:120px;object-fit:cover;border-radius:4px;margin-bottom:4px;"><div style="font-weight:bold;font-size:12px;margin-bottom:8px;">${s.title}</div><a href="/spots/${s.slug}" style="display:block;text-align:center;background:#004098;color:white;padding:6px;border-radius:4px;font-size:11px;font-weight:bold;text-decoration:none;">詳細を見る</a></div>`;
                markers.addLayer(L.marker([s.lat, s.lng]).bindPopup(html));
            }
        });
        map.addLayer(markers);
        const btn = document.getElementById('rpg-btn');
        btn.addEventListener('click', () => {
            document.body.classList.toggle('rpg-mode');
            localStorage.setItem('rpg-mode', document.body.classList.contains('rpg-mode'));
        });
    </script>
</Layout>