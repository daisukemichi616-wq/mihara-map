---
import Layout from '../layouts/Layout.astro';
import { fetchSpots } from '../utils/google-sheets';

const spots = await fetchSpots();
const reversedSpots = [...spots].reverse();
---
<Layout>
    <nav class="fixed-nav">
        <div class="header-logo" id="header-logo">MIHARA REDISCOVER</div>
        <div class="nav-links-wrap">
            <a href="#gallery" class="nav-simple-link">マップ</a>
            <a href="#contact" class="nav-simple-link">掲載募集</a>
            <a href="#guideline" class="nav-simple-link">掲載案内</a>
            <button id="rpg-toggle-btn" onclick="toggleRPGMode()">
                <i class="fa-solid fa-dungeon"></i> <span>冒険の扉</span>
            </button>
        </div>
    </nav>

    <section class="relative w-full h-[80vh] overflow-hidden">
        <div class="absolute inset-0">
             <div class="slide active absolute inset-0 transition-opacity duration-1000"><img src="https://i.postimg.cc/Dy2sThhC/IMG-9586.jpg" class="w-full h-full object-cover"></div>
             <div class="slide absolute inset-0 opacity-0 transition-opacity duration-1000"><img src="https://i.postimg.cc/Z56hFGB9/IMG-9585.jpg" class="w-full h-full object-cover"></div>
        </div>
        <div class="absolute inset-0 bg-black/20 z-10"></div>
        <div class="relative z-20 h-full flex flex-col justify-center items-center text-white text-center px-5">
            <span id="hero-label" class="text-[#f5d76e] text-xs font-bold tracking-[0.4em] mb-6">MIHARA REDISCOVER PROJECT</span>
            <h1 id="hero-title" class="serif-custom text-3xl md:text-5xl leading-relaxed">まだ知らない三原の景色を、<br>みんなで描くフォトマップ</h1>
        </div>
    </section>

    <section id="about" class="section-wrap bg-white">
        <div class="inner-limit">
            <span id="label-about" class="section-tag-label">About Project</span>
            <h3 id="title-about" class="serif-custom text-[#004098] text-2xl mb-12">みんなで描く、三原の未来</h3>
            <div id="card-about" class="card-frame border-2 border-blue-50">
                <p class="text-sm font-bold text-justify">広島県三原市は、瀬戸内海の穏やかな気候と豊かな自然に恵まれた街です。このプロジェクトは、そんな三原の日常にある「美しさ」を再発見するためのもの。地元の人だけが知る特別な場所や、日常のふとした風景を写真で紡ぎ、共有していきます。</p>
            </div>
        </div>
    </section>

    <section id="gallery" class="bg-white">
        <div class="text-center py-10">
            <h3 id="title-map" class="serif-custom text-[#004098] text-2xl mb-4">PHOTO MAP</h3>
            <p id="sub-map" class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-6">Find Your Favorite Spot</p>
            <div class="flex justify-center gap-4">
                <button id="btn-view-grid" onclick="switchView('grid')" class="bg-[#004098] text-white px-6 py-2 rounded-full text-xs font-bold">PHOTO</button>
                <button id="btn-view-map" onclick="switchView('map')" class="bg-gray-100 text-gray-400 px-6 py-2 rounded-full text-xs font-bold">MAP</button>
            </div>
        </div>

        <nav class="sticky-tab-bar">
            <div class="tab-flex">
                <div class="tab-item active" data-area="all">ぜんぶ</div>
                <div class="tab-item" data-area="mihara">三原市街</div>
                <div class="tab-item" data-area="daiwa">大和</div>
                <div class="tab-item" data-area="kui">久井</div>
                <div class="tab-item" data-area="hongo">本郷</div>
                <div class="tab-item" data-area="sagi">佐木島</div>
            </div>
        </nav>
        
        <div id="gallery-wrap">
            <div id="gallery-grid" class="photo-grid">
                {reversedSpots.map((spot) => (
                    <a href={`/spots/${spot.slug}`} class="photo-item block group" data-area={spot.area}>
                        <img src={spot.imageUrl} alt={spot.title} loading="lazy">
                        <div class="photo-overlay">
                            <span class="text-white text-[9px] font-bold tracking-widest uppercase mb-1">{spot.areaLabel}</span>
                            <span class="text-white text-sm font-bold serif-custom">{spot.title}</span>
                        </div>
                    </a>
                ))}
            </div>
        </div>
        <div id="map-container" class="w-full h-[60vh] hidden border-y border-slate-200"></div>
    </section>

    <section id="contact" class="section-wrap bg-[#f0f7ff] border-t border-slate-200">
        <div class="inner-limit">
            <span id="label-contact" class="section-tag-label">Photo Submission</span>
            <h2 id="title-contact" class="h2-one-line serif-custom text-[#004098]">三原の魅力を教えてください</h2>
            <div class="insta-cta-box bg-white p-10 rounded-2xl border-2 border-dashed border-blue-100">
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-6">Contact via Instagram</p>
                <a href="https://www.instagram.com/mihara_sampo" target="_blank" class="bg-gradient-to-r from-orange-400 to-pink-600 text-white font-bold py-4 px-10 rounded-full inline-block shadow-lg">InstagramでDMを送る</a>
            </div>
        </div>
    </section>

    <section id="guideline" class="section-wrap bg-white">
        <div class="inner-limit">
            <span class="section-tag-label">Guidelines</span>
            <h2 class="h2-one-line serif-custom text-slate-800">写真掲載についてのご案内</h2>
            <div class="space-y-6">
                <div class="card-frame"><h4>写真掲載のルール</h4><p>地域の魅力を伝えることを目的に、風景やお店、日常のひとコマを掲載しています。</p></div>
                <div class="card-frame"><h4>権利とマナー</h4><p>著作権は撮影者本人にあります。人物や私有地が写る場合は必ず許可を得てからご投稿ください。</p></div>
            </div>
        </div>
    </section>

    <footer class="footer-main py-16 bg-white border-t text-center">
        <p class="text-[9px] font-bold text-gray-400 tracking-[0.3em] uppercase mb-3">&copy; 2026 Mihara Walk Photo Map</p>
        <p class="text-[8px] text-slate-300 tracking-widest">PRODUCED BY MICHIM</p>
    </footer>

    <script id="spots-data" type="application/json">{JSON.stringify(reversedSpots)}</script>

    <script is:inline>
        const originalTexts = {};
        function toggleRPGMode() {
            const isRPG = document.body.classList.toggle('rpg-mode');
            localStorage.setItem('rpg-mode', isRPG);
            const btn = document.getElementById('rpg-toggle-btn');
            if (isRPG) {
                btn.innerHTML = '<i class="fa-solid fa-book-open"></i> <span>現代に戻る</span>';
                swapText('header-logo', 'MIHARA QUEST');
                swapText('hero-title', '勇者よ、まだ見ぬ三原の<br>地図を完成させるのだ');
            } else {
                btn.innerHTML = '<i class="fa-solid fa-dungeon"></i> <span>冒険の扉</span>';
                restoreText('header-logo');
                restoreText('hero-title');
            }
        }
        function swapText(id, txt) { const el = document.getElementById(id); if (el) { originalTexts[id] = el.innerHTML; el.innerHTML = txt; } }
        function restoreText(id) { const el = document.getElementById(id); if (el && originalTexts[id]) el.innerHTML = originalTexts[id]; }

        function switchView(mode) {
            const grid = document.getElementById('gallery-wrap');
            const mapC = document.getElementById('map-container');
            const bG = document.getElementById('btn-view-grid');
            const bM = document.getElementById('btn-view-map');
            if (mode === 'grid') { grid.style.display = 'block'; mapC.style.display = 'none'; bG.className = 'bg-[#004098] text-white px-6 py-2 rounded-full text-xs font-bold'; bM.className = 'bg-gray-100 text-gray-400 px-6 py-2 rounded-full text-xs font-bold'; }
            else { grid.style.display = 'none'; mapC.style.display = 'block'; bM.className = 'bg-[#004098] text-white px-6 py-2 rounded-full text-xs font-bold'; bG.className = 'bg-gray-100 text-gray-400 px-6 py-2 rounded-full text-xs font-bold'; if (!window.mapInstance) initMap(); else setTimeout(() => window.mapInstance.invalidateSize(), 200); }
        }
        function initMap() {
            const data = JSON.parse(document.getElementById('spots-data').textContent);
            window.mapInstance = L.map('map-container').setView([34.4000, 133.0800], 12);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(window.mapInstance);
            const cluster = L.markerClusterGroup({ showCoverageOnHover: false });
            data.forEach(s => {
                if (s.lat && s.lng) {
                    const html = `<div style="width:200px"><img src="${s.imageUrl}" style="width:100%;height:100px;object-fit:cover;"><div style="padding:10px;font-weight:bold;">${s.title}</div><a href="/spots/${s.slug}" style="display:block;text-align:right;color:#004098;font-size:11px;">詳細を見る →</a></div>`;
                    cluster.addLayer(L.marker([s.lat, s.lng]).bindPopup(html));
                }
            });
            window.mapInstance.addLayer(cluster);
        }
        document.querySelectorAll('.tab-item').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active')); tab.classList.add('active');
                const area = tab.getAttribute('data-area');
                document.querySelectorAll('.photo-item').forEach(item => { item.style.display = (area === 'all' || item.getAttribute('data-area') === area) ? 'block' : 'none'; });
            });
        });
        if (localStorage.getItem('rpg-mode') === 'true') toggleRPGMode();
    </script>
</Layout>