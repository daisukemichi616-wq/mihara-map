---
import Layout from '../layouts/Layout.astro';
import { fetchSpots } from '../utils/google-sheets';

const spots = await fetchSpots();
const reversedSpots = [...spots].reverse();
---
<Layout>
    <!-- Header -->
    <nav class="fixed-nav">
        <div class="header-logo" id="header-logo">MIHARA REDISCOVER</div>
        <div class="nav-links-wrap">
            <a href="#gallery" class="nav-simple-link">マップ</a>
            <a href="#contact" class="nav-simple-link">募集</a>
            <button id="rpg-toggle-btn">
                <i class="fa-solid fa-dungeon"></i> <span>冒険の扉</span>
            </button>
        </div>
    </nav>

    <!-- Hero -->
    <section class="relative w-full h-[80vh] bg-[#f7f7f7] overflow-hidden">
        <div class="absolute inset-0">
             <img src="https://i.postimg.cc/Dy2sThhC/IMG-9586.jpg" class="w-full h-full object-cover" />
             <div class="absolute inset-0 bg-black/20"></div>
        </div>
        <div class="relative z-10 flex flex-col justify-center items-center h-full text-center text-white px-5">
            <span id="hero-label" class="hero-label text-[#f5d76e] font-bold tracking-[0.4em] mb-6 text-xs block">MIHARA REDISCOVER PROJECT</span>
            <h1 id="hero-title" class="serif-custom text-3xl md:text-5xl leading-relaxed drop-shadow-lg">まだ知らない三原の景色を、<br>みんなで描くフォトマップ</h1>
        </div>
    </section>

    <!-- About -->
    <section id="about" class="section-wrap bg-white">
        <div class="inner-limit">
            <span id="label-about" class="section-tag-label">About Project</span>
            <h3 id="title-about" class="serif-custom text-[#004098] text-2xl mb-12">みんなで描く、三原の未来</h3>
            <div id="card-about" class="card-frame border-2 border-blue-50">
                <p class="text-sm font-bold text-justify leading-loose text-gray-600">広島県三原市は、瀬戸内海の穏やかな気候と豊かな自然に恵まれた街です。このプロジェクトは、そんな三原の日常にある「美しさ」を再発見するためのもの。地元の人だけが知る特別な場所や、日常のふとした風景を写真で紡ぎ、共有していきます。</p>
            </div>
        </div>
    </section>

    <!-- Gallery / MAP -->
    <section id="gallery" class="section-wrap bg-white" style="padding-top: 0;">
        <div class="inner-limit">
            <h3 id="title-map" class="serif-custom text-[#004098] text-2xl mb-4">PHOTO MAP</h3>
            <p id="sub-map" class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-6">Find Your Favorite Spot</p>
            
            <div class="flex justify-center gap-4 mb-8">
                <button id="btn-view-grid" class="bg-[#004098] text-white px-6 py-2 rounded-full text-xs font-bold shadow-md">PHOTO</button>
                <button id="btn-view-map" class="bg-gray-200 text-gray-500 px-6 py-2 rounded-full text-xs font-bold hover:bg-gray-300">MAP</button>
            </div>
        </div>

        <nav class="sticky-tab-bar">
            <div class="tab-flex">
                <div class="tab-item active" data-area="all">ぜんぶ</div>
                <div class="tab-item" data-area="mihara">三原市街</div>
                <div class="tab-item" data-area="daiwa">大和</div>
                <div class="tab-item" data-area="kui">久井</div>
                <div class="tab-item" data-area="hongo">本郷</div>
                <div class="tab-item" data-area="sagi">佐木島</div>
            </div>
        </nav>

        <div id="gallery-wrap">
            <div id="gallery-grid" class="photo-grid">
                {reversedSpots.map((spot) => (
                    <a href={`/spots/${spot.slug}`} class="photo-item block group" data-area={spot.area}>
                        <img src={spot.imageUrl} alt={spot.title} loading="lazy" />
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition duration-300 flex flex-col justify-end p-3">
                            <span class="text-white text-[9px] font-bold tracking-widest uppercase mb-1">{spot.areaLabel}</span>
                            <span class="text-white text-xs font-bold serif-custom">{spot.title}</span>
                        </div>
                    </a>
                ))}
            </div>
        </div>

        <div id="map-container" class="w-full h-[60vh] min-h-[500px] hidden border-y border-slate-200"></div>
    </section>

    <!-- Contact -->
    <section id="contact" class="section-wrap bg-[#f0f7ff] border-t border-slate-200">
        <div class="inner-limit">
            <span id="label-contact" class="section-tag-label">Photo Submission</span>
            <h2 id="title-contact" class="h2-one-line serif-custom">三原の魅力を教えてください</h2>
            <p id="text-contact-desc" class="text-sm text-gray-500 leading-loose font-bold mb-12">隠れた名所、美味しいグルメ、四季折々の風景など、三原の魅力が伝わる写真を募集しています。</p>
            <div class="insta-cta-box">
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-4">Contact via Instagram</p>
                <a href="https://www.instagram.com/mihara_sampo" target="_blank" class="insta-btn-final"><i class="fa-brands fa-instagram text-xl"></i> InstagramでDMを送る</a>
            </div>
        </div>
    </section>

    <footer class="footer-main">
        <p class="footer-copy">&copy; 2026 Mihara Walk Photo Map</p>
        <p class="footer-produced">PRODUCED BY MICHIM</p>
    </footer>

    <!-- Data -->
    <script id="spots-data" type="application/json">{JSON.stringify(reversedSpots)}</script>

    <!-- Client Scripts -->
    <script>
        import L from 'leaflet';
        import 'leaflet.markercluster';

        // --- Tabs ---
        const tabs = document.querySelectorAll('.tab-item');
        const items = document.querySelectorAll('.photo-item');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                const area = tab.getAttribute('data-area');
                items.forEach(item => {
                    item.style.display = (area === 'all' || item.getAttribute('data-area') === area) ? 'block' : 'none';
                });
            });
        });

        // --- View Switch ---
        const btnGrid = document.getElementById('btn-view-grid');
        const btnMap = document.getElementById('btn-view-map');
        const galleryWrap = document.getElementById('gallery-wrap');
        const mapContainer = document.getElementById('map-container');
        let map;

        function switchView(mode) {
            if (mode === 'grid') {
                galleryWrap.style.display = 'block';
                mapContainer.style.display = 'none';
                btnGrid.classList.replace('bg-gray-200', 'bg-[#004098]');
                btnGrid.classList.replace('text-gray-500', 'text-white');
                btnMap.classList.replace('bg-[#004098]', 'bg-gray-200');
                btnMap.classList.replace('text-white', 'text-gray-500');
            } else {
                galleryWrap.style.display = 'none';
                mapContainer.style.display = 'block';
                btnMap.classList.replace('bg-gray-200', 'bg-[#004098]');
                btnMap.classList.replace('text-gray-500', 'text-white');
                btnGrid.classList.replace('bg-[#004098]', 'bg-gray-200');
                btnGrid.classList.replace('text-white', 'text-gray-500');
                if(!map) initMap(); else setTimeout(() => map.invalidateSize(), 200);
            }
        }
        btnGrid.addEventListener('click', () => switchView('grid'));
        btnMap.addEventListener('click', () => switchView('map'));

        // --- Map ---
        function initMap() {
            const spots = JSON.parse(document.getElementById('spots-data').textContent);
            map = L.map('map-container', {scrollWheelZoom: false}).setView([34.4000, 133.0800], 12);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: 'OSM' }).addTo(map);
            const markers = L.markerClusterGroup({ showCoverageOnHover: false });
            spots.forEach(s => {
                if(s.lat && s.lng) {
                    const html = `<div style="width:200px"><img src="${s.imageUrl}" style="width:100%;height:120px;object-fit:cover;border-radius:4px;margin-bottom:8px;"><div style="font-weight:bold;font-size:12px;margin-bottom:8px;font-family:'Noto Serif JP';">${s.title}</div><a href="/spots/${s.slug}" style="display:block;text-align:center;background:#004098;color:white;padding:8px;border-radius:4px;font-size:11px;font-weight:bold;text-decoration:none;">詳細を見る</a></div>`;
                    markers.addLayer(L.marker([s.lat, s.lng]).bindPopup(html));
                }
            });
            map.addLayer(markers);
        }

        // --- RPG Mode ---
        const btn = document.getElementById('rpg-toggle-btn');
        const originalTexts = {};
        function swapText(id, text) {
            const el = document.getElementById(id);
            if(el) { if(!originalTexts[id]) originalTexts[id] = el.innerHTML; el.innerHTML = text; }
        }
        function restoreText(id) {
            const el = document.getElementById(id);
            if(el && originalTexts[id]) el.innerHTML = originalTexts[id];
        }
        function toggleRPG() {
            document.body.classList.toggle('rpg-mode');
            const isRPG = document.body.classList.contains('rpg-mode');
            localStorage.setItem('rpg-mode', isRPG);
            if(isRPG) {
                btn.innerHTML = '<i class="fa-solid fa-book-open"></i> <span>現代に戻る</span>';
                swapText('header-logo', 'MIHARA QUEST');
                swapText('hero-label', 'MIHARA QUEST PROJECT');
                swapText('hero-title', '勇者よ、まだ見ぬ三原の<br>地図を完成させるのだ');
                swapText('title-about', '冒険の目的');
                swapText('card-about', '<p class="text-sm font-bold leading-loose">ここ ミハラは いにしえより つづく まち。<br><br>ゆうしゃよ、このせかいに かくれた「うるわしきもの」を さがしだすのだ。<br><br>それが みつかりしとき、あらたな でんせつが はじまる！</p>');
                swapText('title-map', 'WORLD MAP');
                swapText('sub-map', 'Find Hidden Treasures');
                swapText('title-contact', '情報をギルドに送る');
            } else {
                btn.innerHTML = '<i class="fa-solid fa-dungeon"></i> <span>冒険の扉</span>';
                ['header-logo', 'hero-label', 'hero-title', 'title-about', 'card-about', 'title-map', 'sub-map', 'title-contact'].forEach(id => restoreText(id));
            }
        }
        btn.addEventListener('click', toggleRPG);
        if(localStorage.getItem('rpg-mode') === 'true') toggleRPG();
    </script>
</Layout>