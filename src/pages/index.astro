---
import Layout from '../layouts/Layout.astro';
import { fetchSpots } from '../utils/google-sheets';

const spots = await fetchSpots();
const reversedSpots = [...spots].reverse();
---
<Layout>
    <nav class="fixed top-0 left-0 w-full h-[60px] bg-white/98 backdrop-blur z-50 border-b border-slate-200 flex justify-between items-center px-4 transition-all duration-500">
        <div id="header-logo" class="font-bold text-blue-900 tracking-widest text-sm md:text-base">MIHARA REDISCOVER</div>
        <div class="flex gap-4 items-center">
            <a href="#gallery" class="text-[10px] md:text-xs font-bold text-gray-400 hover:text-blue-900">マップ</a>
            <a href="#contact" class="text-[10px] md:text-xs font-bold text-gray-400 hover:text-blue-900">募集</a>
            <button id="rpg-toggle-btn" class="flex items-center gap-2 bg-[#004098] text-white px-3 py-1.5 rounded-full text-[10px] font-bold shadow-md hover:translate-y-px transition">
                <i class="fa-solid fa-dungeon text-[#f5d76e]"></i> <span>冒険の扉</span>
            </button>
        </div>
    </nav>

    <section class="relative w-full h-[80vh] bg-[#f7f7f7] overflow-hidden">
        <div class="absolute inset-0 z-0 slider-container">
             <div class="slide active absolute inset-0 opacity-100 transition-opacity duration-1000"><img src="https://i.postimg.cc/Dy2sThhC/IMG-9586.jpg" class="w-full h-full object-cover" /></div>
             <div class="slide absolute inset-0 opacity-0 transition-opacity duration-1000"><img src="https://i.postimg.cc/Z56hFGB9/IMG-9585.jpg" class="w-full h-full object-cover" /></div>
             <div class="slide absolute inset-0 opacity-0 transition-opacity duration-1000"><img src="https://i.postimg.cc/cLypHF9y/IMG-9584.jpg" class="w-full h-full object-cover" /></div>
        </div>
        <div class="absolute inset-0 bg-gradient-to-b from-black/5 to-black/30 z-10"></div>
        <div class="relative z-20 h-full flex flex-col justify-center items-center text-center text-white px-5">
            <span id="hero-label" class="block text-xs font-bold tracking-[0.4em] text-[#f5d76e] mb-6 drop-shadow-md">MIHARA REDISCOVER PROJECT</span>
            <h1 id="hero-title" class="serif-custom text-3xl md:text-5xl leading-relaxed drop-shadow-lg">まだ知らない三原の景色を、<br>みんなで描くフォトマップ</h1>
        </div>
    </section>

    <section id="about" class="py-24 px-6 bg-white section-wrap transition-colors duration-500">
        <div class="max-w-3xl mx-auto text-center">
            <span id="label-about" class="section-tag-label">About Project</span>
            <h3 id="title-about" class="serif-custom text-[#004098] text-2xl mb-12">みんなで描く、三原の未来</h3>
            <div id="card-about" class="card-frame border-2 border-blue-50">
                <p class="text-sm font-bold text-justify leading-loose text-gray-600">広島県三原市は、瀬戸内海の穏やかな気候と豊かな自然に恵まれた街です。このプロジェクトは、そんな三原の日常にある「美しさ」を再発見するためのもの。地元の人だけが知る特別な場所や、日常のふとした風景を写真で紡ぎ、共有していきます。</p>
            </div>
        </div>
    </section>

    <section id="gallery" class="pb-24 bg-white section-wrap transition-colors duration-500">
        <div class="text-center px-6">
            <h3 id="title-map" class="serif-custom text-[#004098] text-2xl mb-4">PHOTO MAP</h3>
            <p id="sub-map" class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-6">Find Your Favorite Spot</p>
            
            <div class="view-switch inline-flex bg-slate-100 p-1 rounded-full mb-8">
                <button id="btn-view-grid" class="view-btn active px-6 py-2 rounded-full text-[10px] font-bold bg-white text-blue-900 shadow-sm transition-all">PHOTO</button>
                <button id="btn-view-map" class="view-btn px-6 py-2 rounded-full text-[10px] font-bold text-gray-400 hover:text-blue-900 transition-all">MAP</button>
            </div>
        </div>

        <nav class="sticky top-[60px] bg-white/95 z-40 border-b-2 border-blue-900 overflow-x-auto whitespace-nowrap mb-0 sticky-tab-bar">
            <div class="flex justify-center px-4 tab-flex">
                <div class="tab-item active px-4 py-4 text-sm font-bold text-blue-900 border-b-4 border-blue-900 cursor-pointer" data-area="all">ぜんぶ</div>
                <div class="tab-item px-4 py-4 text-sm font-bold text-gray-400 border-b-4 border-transparent hover:text-blue-900 cursor-pointer" data-area="mihara">三原市街</div>
                <div class="tab-item px-4 py-4 text-sm font-bold text-gray-400 border-b-4 border-transparent hover:text-blue-900 cursor-pointer" data-area="daiwa">大和</div>
                <div class="tab-item px-4 py-4 text-sm font-bold text-gray-400 border-b-4 border-transparent hover:text-blue-900 cursor-pointer" data-area="kui">久井</div>
                <div class="tab-item px-4 py-4 text-sm font-bold text-gray-400 border-b-4 border-transparent hover:text-blue-900 cursor-pointer" data-area="hongo">本郷</div>
                <div class="tab-item px-4 py-4 text-sm font-bold text-gray-400 border-b-4 border-transparent hover:text-blue-900 cursor-pointer" data-area="sagi">佐木島</div>
            </div>
        </nav>

        <div id="gallery-wrap" class="block">
            <div id="gallery-grid" class="grid grid-cols-3 md:grid-cols-4 gap-1 bg-slate-200">
                {reversedSpots.map((spot) => (
                    <a href={`/spots/${spot.slug}`} class="photo-item block relative aspect-square group overflow-hidden bg-gray-100" data-area={spot.area}>
                        <img src={spot.imageUrl} alt={spot.title} class="w-full h-full object-cover transition duration-700 group-hover:scale-110" loading="lazy" />
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition duration-300 flex flex-col justify-end p-3">
                            <span class="text-white text-[9px] font-bold tracking-widest uppercase mb-1">{spot.areaLabel}</span>
                            <span class="text-white text-xs font-bold serif-custom">{spot.title}</span>
                        </div>
                    </a>
                ))}
            </div>
        </div>

        <div id="map-container" class="w-full h-[60vh] min-h-[500px] hidden border-y border-slate-200"></div>
    </section>

    <section id="contact" class="py-24 px-6 bg-[#f0f7ff] border-t border-slate-200 section-wrap transition-colors duration-500">
        <div class="max-w-3xl mx-auto text-center">
            <span id="label-contact" class="section-tag-label">Photo Submission</span>
            <h2 id="title-contact" class="h2-one-line serif-custom">三原の魅力を教えてください</h2>
            <p id="text-contact-desc" class="text-sm text-gray-500 leading-loose font-bold mb-12">隠れた名所、美味しいグルメ、四季折々の風景など、三原の魅力が伝わる写真を募集しています。</p>
            <div class="insta-cta-box bg-white p-10 rounded-2xl border-2 border-dashed border-blue-100 inline-block w-full max-w-md mx-auto">
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-4">Contact via Instagram</p>
                <a href="https://www.instagram.com/mihara_sampo" target="_blank" class="flex items-center justify-center gap-3 bg-gradient-to-r from-orange-400 to-pink-600 text-white font-bold py-4 rounded-full shadow-lg hover:opacity-90 transition"><i class="fa-brands fa-instagram text-xl"></i> InstagramでDMを送る</a>
            </div>
        </div>
    </section>

    <footer class="text-center py-16 bg-white border-t border-slate-200 footer-main transition-colors duration-500">
        <p class="text-[9px] font-bold text-gray-400 tracking-[0.3em] uppercase mb-3">&copy; 2026 Mihara Walk Photo Map</p>
        <p class="text-[8px] font-medium text-slate-300 tracking-widest uppercase">PRODUCED BY MICHIM</p>
    </footer>

    <script id="spots-data" type="application/json">{JSON.stringify(reversedSpots)}</script>

    <script>
        import L from 'leaflet';
        import 'leaflet.markercluster';

        // --- スライダーJS ---
        let currentSlide = 0;
        const slides = document.querySelectorAll('.slide');
        setInterval(() => {
            slides[currentSlide].style.opacity = '0';
            currentSlide = (currentSlide + 1) % slides.length;
            slides[currentSlide].style.opacity = '1';
        }, 6000);

        // --- タブ切り替えJS ---
        const tabs = document.querySelectorAll('.tab-item');
        const items = document.querySelectorAll('.photo-item');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => { t.classList.remove('active', 'text-blue-900', 'border-blue-900'); t.classList.add('text-gray-400', 'border-transparent'); });
                tab.classList.add('active', 'text-blue-900', 'border-blue-900');
                tab.classList.remove('text-gray-400', 'border-transparent');
                
                const area = tab.getAttribute('data-area');
                items.forEach(item => {
                    item.style.display = (area === 'all' || item.getAttribute('data-area') === area) ? 'block' : 'none';
                });
            });
        });

        // --- 表示切り替えJS ---
        const btnGrid = document.getElementById('btn-view-grid');
        const btnMap = document.getElementById('btn-view-map');
        const galleryWrap = document.getElementById('gallery-wrap');
        const mapContainer = document.getElementById('map-container');
        let map;

        function switchView(mode) {
            if (mode === 'grid') {
                galleryWrap.style.display = 'block';
                mapContainer.style.display = 'none';
                btnGrid.classList.add('active', 'bg-white', 'text-blue-900', 'shadow-sm');
                btnGrid.classList.remove('text-gray-400');
                btnMap.classList.remove('active', 'bg-white', 'text-blue-900', 'shadow-sm');
                btnMap.classList.add('text-gray-400');
            } else {
                galleryWrap.style.display = 'none';
                mapContainer.style.display = 'block';
                btnMap.classList.add('active', 'bg-white', 'text-blue-900', 'shadow-sm');
                btnMap.classList.remove('text-gray-400');
                btnGrid.classList.remove('active', 'bg-white', 'text-blue-900', 'shadow-sm');
                btnGrid.classList.add('text-gray-400');
                if(!map) initMap();
                else setTimeout(() => map.invalidateSize(), 200);
            }
        }
        btnGrid.addEventListener('click', () => switchView('grid'));
        btnMap.addEventListener('click', () => switchView('map'));

        // --- マップJS ---
        function initMap() {
            const spots = JSON.parse(document.getElementById('spots-data').textContent);
            map = L.map('map-container', {scrollWheelZoom: false}).setView([34.4000, 133.0800], 12);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: 'OSM' }).addTo(map);
            const markers = L.markerClusterGroup({ showCoverageOnHover: false });
            spots.forEach(s => {
                if(s.lat && s.lng) {
                    const html = `<div style="width:200px"><img src="${s.imageUrl}" style="width:100%;height:120px;object-fit:cover;border-radius:4px;margin-bottom:8px;"><div style="font-weight:bold;font-size:12px;margin-bottom:8px;font-family:'Noto Serif JP';">${s.title}</div><a href="/spots/${s.slug}" style="display:block;text-align:center;background:#004098;color:white;padding:8px;border-radius:4px;font-size:11px;font-weight:bold;text-decoration:none;">詳細を見る</a></div>`;
                    markers.addLayer(L.marker([s.lat, s.lng]).bindPopup(html));
                }
            });
            map.addLayer(markers);
        }

        // --- RPGモードJS ---
        const btn = document.getElementById('rpg-toggle-btn');
        const originalTexts = {};
        function swapText(id, text) {
            const el = document.getElementById(id);
            if(el) { if(!originalTexts[id]) originalTexts[id] = el.innerHTML; el.innerHTML = text; }
        }
        function restoreText(id) {
            const el = document.getElementById(id);
            if(el && originalTexts[id]) el.innerHTML = originalTexts[id];
        }
        function toggleRPG() {
            document.body.classList.toggle('rpg-mode');
            const isRPG = document.body.classList.contains('rpg-mode');
            localStorage.setItem('rpg-mode', isRPG);
            if(isRPG) {
                btn.innerHTML = '<i class="fa-solid fa-book-open"></i> <span>現代に戻る</span>';
                swapText('header-logo', 'MIHARA QUEST');
                swapText('hero-label', 'MIHARA QUEST PROJECT');
                swapText('hero-title', '勇者よ、まだ見ぬ三原の<br>地図を完成させるのだ');
                swapText('title-about', '冒険の目的');
                swapText('card-about', '<p class="text-sm font-bold leading-loose">ここ ミハラは いにしえより つづく まち。<br><br>ゆうしゃよ、このせかいに かくれた「うるわしきもの」を さがしだすのだ。<br><br>それが みつかりしとき、あらたな でんせつが はじまる！</p>');
                swapText('title-map', 'WORLD MAP');
                swapText('sub-map', 'Find Hidden Treasures');
                swapText('title-contact', '情報をギルドに送る');
            } else {
                btn.innerHTML = '<i class="fa-solid fa-dungeon text-[#f5d76e]"></i> <span>冒険の扉</span>';
                ['header-logo', 'hero-label', 'hero-title', 'title-about', 'card-about', 'title-map', 'sub-map', 'title-contact'].forEach(id => restoreText(id));
            }
        }
        btn.addEventListener('click', toggleRPG);
        if(localStorage.getItem('rpg-mode') === 'true') toggleRPG();
    </script>
</Layout>