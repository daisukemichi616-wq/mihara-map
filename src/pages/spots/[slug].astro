---
import Layout from '../../layouts/Layout.astro';
import { fetchSpots } from '../../utils/google-sheets';

export async function getStaticPaths() {
    const allSpots = await fetchSpots();
    const sortedSpots = [...allSpots].reverse();
    return sortedSpots.map((spot, index) => {
        const prevSpot = index > 0 ? sortedSpots[index - 1] : null;
        const nextSpot = index < sortedSpots.length - 1 ? sortedSpots[index + 1] : null;
        const relatedSpots = sortedSpots.filter(s => s.area === spot.area && s.slug !== spot.slug).slice(0, 3);
        return { params: { slug: spot.slug }, props: { spot, prevSpot, nextSpot, relatedSpots } };
    });
}
const { spot, prevSpot, nextSpot, relatedSpots } = Astro.props;
---
<Layout title={spot.title} description={spot.desc} image={spot.imageUrl}>
    <nav class="fixed-nav">
        <a href="/" class="header-logo" style="cursor:pointer; text-decoration:none;"><i class="fa-solid fa-arrow-left"></i> MAPに戻る</a>
        <div class="header-logo">MIHARA REDISCOVER</div>
    </nav>
    <div style="padding-top:100px; padding-bottom:60px; min-h:100vh; background:#f3f4f6; display:flex; justify-content:center;">
        <div class="card-frame" style="width:100%; max-width:600px; margin:0 20px; padding:0; overflow:hidden;">
            <img src={spot.imageUrl} style="width:100%; aspect-ratio:1/1; object-fit:cover;">
            <div style="padding:30px;">
                <span class="section-tag-label" id="modal-area" style="margin-bottom:10px;">{spot.areaLabel}</span>
                <h1 id="modal-title" class="serif-custom" style="font-size:1.5rem; margin-bottom:20px; color:#1a1a1a;">{spot.title}</h1>
                <p id="modal-desc" style="font-size:0.9rem; color:#4b5563; line-height:2.0; margin-bottom:30px; white-space:pre-wrap;">{spot.desc || '紹介文がありません。'}</p>
                <a href={spot.map_url || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent("三原市 " + spot.title)}`} target="_blank" style="display:block; text-align:center; padding:15px; border:1px solid #004098; color:#004098; font-weight:bold; border-radius:8px; text-decoration:none; font-size:0.8rem; margin-bottom:30px;"><i class="fa-solid fa-location-dot"></i> この場所をGoogleマップで見る</a>
                
                <div style="border-top:1px solid #e2e8f0; padding-top:20px; display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:9px; font-weight:bold; color:#cbd5e1; letter-spacing:0.1em;">PHOTO BY {spot.author || '管理者'}</span>
                    {spot.sns && <a href={spot.sns} target="_blank" style="font-size:10px; font-weight:bold; color:#1a1a1a; border-bottom:1px solid #1a1a1a; text-decoration:none;">INSTAGRAM</a>}
                </div>
            </div>
            
            <div style="background:#f9fafb; padding:20px; border-top:1px solid #e2e8f0;">
                 <h4 style="text-align:center; font-size:10px; font-weight:bold; color:#004098; margin-bottom:15px;">NEARBY SPOTS</h4>
                 <div style="display:flex; justify-content:space-between;">
                     <div style="width:48%; text-align:left;">{prevSpot && <a href={`/spots/${prevSpot.slug}`} style="font-size:10px; font-weight:bold; color:#9ca3af; text-decoration:none;">← {prevSpot.title}</a>}</div>
                     <div style="width:48%; text-align:right;">{nextSpot && <a href={`/spots/${nextSpot.slug}`} style="font-size:10px; font-weight:bold; color:#9ca3af; text-decoration:none;">{nextSpot.title} →</a>}</div>
                 </div>
            </div>
        </div>
    </div>
    
    <script>
        // RPG Mode for Spot Page
        const spotData = { rpg_title: document.getElementById('rpg-title-data')?.textContent, rpg_desc: document.getElementById('rpg-desc-data')?.textContent };
        if (localStorage.getItem('rpg-mode') === 'true') {
            document.body.classList.add('rpg-mode');
            if(spotData.rpg_title) document.getElementById('modal-title').textContent = spotData.rpg_title;
            if(spotData.rpg_desc) document.getElementById('modal-desc').innerHTML = spotData.rpg_desc.replace(/\n/g, '<br>');
            const areaLabel = document.getElementById('modal-area');
            if(areaLabel) areaLabel.style.color = '#f5d76e';
        }
    </script>
    <div style="display:none;" id="rpg-title-data">{spot.rpg_title}</div>
    <div style="display:none;" id="rpg-desc-data">{spot.rpg_desc}</div>
</Layout>