---
import { fetchSpots } from '../../utils/google-sheets';

export async function getStaticPaths() {
    const allSpots = await fetchSpots();
    const sortedSpots = [...allSpots].reverse();
    return sortedSpots.map((spot, index) => {
        const prevSpot = index > 0 ? sortedSpots[index - 1] : null;
        const nextSpot = index < sortedSpots.length - 1 ? sortedSpots[index + 1] : null;
        return { params: { slug: spot.slug }, props: { spot, prevSpot, nextSpot } };
    });
}
const { spot, prevSpot, nextSpot } = Astro.props;
---
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="referrer" content="no-referrer">
    <title>{spot.title} | 三原市まち歩き</title>
    <meta name="description" content={spot.description}>
    <meta property="og:title" content={spot.title}>
    <meta property="og:description" content={spot.description}>
    <meta property="og:image" content={spot.imageUrl}>
    <meta name="twitter:card" content="summary_large_image">

    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700;900&family=Noto+Serif+JP:wght@700;900&family=DotGothic16&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- CSS (index.astroと全く同じものを適用) -->
    <style is:inline>
        :root { --palette-blue: #004098; --palette-blue-light: #e1f5fe; --palette-sky: #f0f7ff; --palette-gold: #f5d76e; --text-main: #1a1a1a; --text-sub: #4b5563; --border-soft: #e2e8f0; }
        html { scroll-behavior: smooth; }
        *:not(i):not(svg):not(polyline):not(rect):not(path):not(circle):not(line) { font-family: 'Zen Maru Gothic', sans-serif !important; font-weight: 500; }
        .serif-custom { font-family: 'Noto Serif JP', serif !important; font-weight: 700 !important; }
        body { color: var(--text-main); background-color: #fff; margin: 0; padding-top: 60px; overflow-x: hidden; line-height: 1.8; }
        
        .fixed-nav { position: fixed; top: 0; left: 0; width: 100%; height: 60px; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(15px); border-bottom: 1px solid var(--border-soft); z-index: 9999; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; }
        .header-logo { font-weight: 700 !important; font-size: 0.8rem; color: var(--palette-blue); letter-spacing: 0.05em; }
        .section-tag-label { font-size: 0.8rem; font-weight: 700 !important; color: var(--palette-blue); letter-spacing: 0.25em; text-transform: uppercase; }
        
        /* RPG Mode */
        body.rpg-mode { background-color: #000 !important; color: #fff !important; font-family: 'DotGothic16', sans-serif !important; }
        body.rpg-mode *:not(i) { font-family: 'DotGothic16', sans-serif !important; letter-spacing: 0.1em; }
        body.rpg-mode .fixed-nav, body.rpg-mode #modal-content-area { background: #00008b !important; border: 3px double #fff !important; color: #fff !important; }
        body.rpg-mode h1, body.rpg-mode p, body.rpg-mode span, body.rpg-mode a { color: #fff !important; text-shadow: 2px 2px 0 #000; }
        body.rpg-mode .text-blue-900, body.rpg-mode .section-tag-label, body.rpg-mode #modal-area, body.rpg-mode #modal-sns { color: #f5d76e !important; border-color: #f5d76e !important; }
        body.rpg-mode #modal-map-btn { border-color: #fff !important; color: #ff0 !important; background: #000 !important; }
    </style>
</head>
<body>
    <nav class="fixed-nav">
        <a href="/" class="header-logo" style="text-decoration:none;"><i class="fa-solid fa-arrow-left"></i> MAPに戻る</a>
        <div class="header-logo">MIHARA REDISCOVER</div>
        <div style="width:40px;"></div>
    </nav>

    <div style="background-color:rgba(0,0,0,0.05); min-height:100vh; padding: 40px 20px; display:flex; justify-content:center; align-items:flex-start;">
        <div id="modal-content-area" class="w-full max-w-[600px] bg-white shadow-2xl rounded-xl overflow-hidden relative mt-4">
            <img src={spot.imageUrl} class="w-full aspect-square object-cover">
            
            <div class="px-8 py-12 text-left">
                <span id="modal-area" class="section-tag-label text-[10px] border border-blue-600 px-3 py-1 mb-6 inline-block">{spot.areaLabel}</span>
                <h1 id="modal-title" class="serif-custom text-2xl mb-4 leading-normal text-slate-800">{spot.title}</h1>
                <p id="modal-desc" class="text-sm font-medium leading-loose mb-8 text-slate-600 whitespace-pre-wrap">{spot.description}</p>
                
                <a id="modal-map-btn" href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent("三原市 " + spot.title)}`} target="_blank" class="mb-10 flex items-center justify-center gap-2 w-full border border-blue-900 text-blue-900 font-bold text-xs py-4 rounded hover:bg-blue-50 transition">
                    <i class="fa-solid fa-location-dot"></i> この場所をGoogleマップで見る
                </a>

                <div class="flex items-center justify-between border-t border-slate-200 pt-8">
                    <span class="text-[9px] font-bold text-gray-400 uppercase tracking-widest">PHOTO BY {spot.authorName}</span>
                    {spot.snsUrl ? (
                        <a id="modal-sns" href={spot.snsUrl} target="_blank" class="text-gray-900 font-bold text-[10px] border-b border-gray-900 pb-1 uppercase hover:opacity-70 transition">Instagram Link</a>
                    ) : (
                        <span class="text-gray-300 text-[10px] font-bold uppercase">No SNS Account</span>
                    )}
                </div>
            </div>
            
            <!-- 前後リンク (SEO対策) -->
            <div class="bg-gray-50 p-4 border-t flex justify-between text-xs font-bold text-gray-400">
                <div class="w-1/2 text-left">{prevSpot && <a href={`/spots/${prevSpot.slug}`} class="hover:text-blue-900 block truncate">← {prevSpot.title}</a>}</div>
                <div class="w-1/2 text-right">{nextSpot && <a href={`/spots/${nextSpot.slug}`} class="hover:text-blue-900 block truncate">{nextSpot.title} →</a>}</div>
            </div>
        </div>
    </div>

    <script is:inline define:vars={{r_title: spot.rpg_title, r_desc: spot.rpg_desc}}>
        if (localStorage.getItem('rpg-mode') === 'true') {
            document.body.classList.add('rpg-mode');
            if (r_title) document.getElementById('modal-title').textContent = r_title;
            if (r_desc) document.getElementById('modal-desc').innerHTML = r_desc.replace(/\n/g, '<br>');
            
            const btn = document.getElementById('modal-map-btn');
            if(btn) btn.innerHTML = '<i class="fa-solid fa-map"></i> ちずを ひらく';
        }
    </script>
</body>
</html>